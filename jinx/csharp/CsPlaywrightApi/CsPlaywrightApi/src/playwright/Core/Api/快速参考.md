# API自动化快速参考

## 快速开始

```csharp
// 1. 创建API上下文
using var playwright = await Playwright.CreateAsync();
var apiContext = await playwright.APIRequest.NewContextAsync(new APIRequestNewContextOptions
{
    BaseURL = "https://api.example.com"
});

// 2. 创建ApiClient
var client = new ApiClient(apiContext);

// 3. 发送请求
var response = await client.GetAsync("/api/users");

// 4. 验证响应
client.AssertSuccess(response);
```

## 常用方法速查

### 请求方法

| 方法 | 说明 | 示例 |
|------|------|------|
| `GetAsync(url, headers, queryParams)` | GET请求 | `await client.GetAsync("/users")` |
| `PostJsonAsync(url, data, headers)` | POST JSON | `await client.PostJsonAsync("/login", data)` |
| `PostFormAsync(url, formData, headers)` | POST 表单 | `await client.PostFormAsync("/login", form)` |
| `PutJsonAsync(url, data, headers)` | PUT请求 | `await client.PutJsonAsync("/users/1", data)` |
| `DeleteAsync(url, headers)` | DELETE请求 | `await client.DeleteAsync("/users/1")` |
| `PatchJsonAsync(url, data, headers)` | PATCH请求 | `await client.PatchJsonAsync("/users/1", data)` |

### 响应处理

| 方法 | 说明 | 示例 |
|------|------|------|
| `GetTextResponseAsync(response)` | 获取文本 | `await client.GetTextResponseAsync(response)` |
| `GetJsonResponseAsync<T>(response)` | 解析JSON | `await client.GetJsonResponseAsync<User>(response)` |
| `ExtractJsonFieldAsync(response, path)` | 提取字段 | `await client.ExtractJsonFieldAsync(response, "data.id")` |

### 断言验证

| 方法 | 说明 | 示例 |
|------|------|------|
| `AssertStatusCode(response, code)` | 验证状态码 | `client.AssertStatusCode(response, 200)` |
| `AssertSuccess(response)` | 验证成功 | `client.AssertSuccess(response)` |
| `ApiAssertions.AssertJsonFieldAsync(response, path, value)` | 验证字段值 | `await ApiAssertions.AssertJsonFieldAsync(response, "code", "0")` |
| `ApiAssertions.AssertContainsTextAsync(response, text)` | 验证包含文本 | `await ApiAssertions.AssertContainsTextAsync(response, "success")` |
| `ApiAssertions.AssertHeaderExists(response, key)` | 验证响应头 | `ApiAssertions.AssertHeaderExists(response, "Content-Type")` |

### 请求头管理

| 方法 | 说明 | 示例 |
|------|------|------|
| `SetDefaultHeaders(headers)` | 设置默认请求头 | `client.SetDefaultHeaders(headers)` |
| `AddDefaultHeader(key, value)` | 添加单个请求头 | `client.AddDefaultHeader("Authorization", token)` |

## 常见场景

### 场景1：带Token的请求

```csharp
// 登录获取token
var loginResponse = await client.PostJsonAsync("/login", loginData);
var token = await client.ExtractJsonFieldAsync(loginResponse, "data.token");

// 设置token到所有后续请求
client.AddDefaultHeader("Authorization", $"Bearer {token}");

// 后续请求会自动携带token
var profileResponse = await client.GetAsync("/user/profile");
```

### 场景2：查询参数

```csharp
var queryParams = new Dictionary<string, string>
{
    ["page"] = "1",
    ["limit"] = "20",
    ["sort"] = "created_at"
};

var response = await client.GetAsync("/api/users", queryParams: queryParams);
// 实际请求: /api/users?page=1&limit=20&sort=created_at
```

### 场景3：表单提交

```csharp
var formData = new Dictionary<string, string>
{
    ["username"] = "test@example.com",
    ["password"] = "password123"
};

var response = await client.PostFormAsync("/login", formData);
```

### 场景4：JSON提交

```csharp
var jsonData = new
{
    name = "张三",
    age = 25,
    email = "zhangsan@example.com"
};

var response = await client.PostJsonAsync("/api/users", jsonData);
```

### 场景5：提取嵌套字段

```csharp
// 响应: {"code": 0, "data": {"user": {"id": 123, "name": "张三"}}}

var userId = await client.ExtractJsonFieldAsync(response, "data.user.id");
var userName = await client.ExtractJsonFieldAsync(response, "data.user.name");
```

### 场景6：完整的CRUD流程

```csharp
// Create
var createData = new { name = "测试用户" };
var createResponse = await client.PostJsonAsync("/api/users", createData);
var userId = await client.ExtractJsonFieldAsync(createResponse, "data.id");

// Read
var readResponse = await client.GetAsync($"/api/users/{userId}");
client.AssertSuccess(readResponse);

// Update
var updateData = new { name = "更新后的用户" };
var updateResponse = await client.PutJsonAsync($"/api/users/{userId}", updateData);

// Delete
var deleteResponse = await client.DeleteAsync($"/api/users/{userId}");
client.AssertStatusCode(deleteResponse, 204);
```

## 继承自定义API类

```csharp
public class MyApi : ApiClient
{
    public MyApi(IAPIRequestContext apiContext, ApiLogger? logger = null) 
        : base(apiContext, logger)
    {
    }

    public async Task<IAPIResponse> LoginAsync(string username, string password)
    {
        var data = new { username, password };
        return await PostJsonAsync("/api/login", data);
    }

    public async Task<IAPIResponse> GetUsersAsync(int page = 1, int limit = 10)
    {
        var queryParams = new Dictionary<string, string>
        {
            ["page"] = page.ToString(),
            ["limit"] = limit.ToString()
        };
        return await GetAsync("/api/users", queryParams: queryParams);
    }
}
```

## 错误处理

```csharp
try
{
    var response = await client.GetAsync("/api/users");
    client.AssertSuccess(response);
    await ApiAssertions.AssertJsonFieldAsync(response, "code", "0");
}
catch (AssertionException ex)
{
    Console.WriteLine($"断言失败: {ex.Message}");
}
catch (Exception ex)
{
    Console.WriteLine($"请求失败: {ex.Message}");
}
```

## 日志功能

所有请求都会自动记录：
- ✅ 请求地址和方法
- ✅ 请求参数和请求头
- ✅ 响应状态码和响应体
- ✅ 响应Code（自动提取）
- ✅ 请求耗时

日志同时输出到控制台和文件，方便调试和追踪。
